run_configurations:
  "cpp-reference":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 1
      "exclusive": "mcs"
      "mem": 16000
    module_loads:
      - "GCC/11.3.0"
      - "likwid/5.2.2"
    environment_variables: {}
    directory: "../0_cpp_versions/0_ref"
    build_commands:
      - "make no_yaml"
      - "make -j 8"
    run_command: "likwid-perfctr -C S0:1 -g MEM ./test_HPCCG"
    # run_command: "./test_HPCCG"

  "rust-reference":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 1
      "exclusive": "mcs"
      "mem": 16000
    module_loads:
      - "GCC/11.3.0"
      - "Clang/13.0.1"
      - "likwid/5.2.2"
    environment_variables: {}
    directory: "../5_iterators"
    build_commands:
      - "cargo build --release"
    run_command: "likwid-perfctr -C S0:1/ -g MEM ./target/release/hpccg-rs"
    # run_command: "./target/release/hpccg-rs"

  "cpp-openmp":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 16
      "exclusive": "mcs"
      "mem": 16000
    module_loads:
      - "GCC/11.3.0"
      - "likwid/5.2.2"
    environment_variables: {}
    directory: "../0_cpp_versions/1_openmp"
    build_commands:
      - "make no_yaml"
      - "make -j 8"
    run_command: "likwid-perfctr -C 0-16 -g MEM ./test_HPCCG"
    # run_command: "./test_HPCCG"

  "rust-rayon":
    sbatch_config:
      "nodes": 1
      "ntasks-per-node": 1
      "cpus-per-task": 16
      "exclusive": "mcs"
      "mem": 16000
    module_loads:
      - "GCC/11.3.0"
      - "Clang/13.0.1"
      - "likwid/5.2.2"
    environment_variables: {}
    directory: "../6_parallel"
    build_commands:
      - "cargo build --release"
    run_command: "likwid-perfctr -C 0-16 -g MEM ./target/release/hpccg-rs"
    # run_command: "./target/release/hpccg-rs"


  "cpp-mpi":
    sbatch_config:
      "exclusive": "mcs"
      "mem": 60000
    module_loads:
      - "GCC/11.3.0"
      - "OpenMPI/4.1.4"
    environment_variables: {}
    directory: "../0_cpp_versions/2_mpi"
    build_commands:
      - "make no_yaml"
      - "make -j 8"
    run_command: "mpirun likwid-perfctr -C S0:1/ -g MEM ./test_HPCCG"

  "rust-mpi":
    sbatch_config:
      "exclusive": "mcs"
      "mem": 60000
    module_loads:
      - "GCC/11.3.0"
      - "Clang/13.0.1"
      - "OpenMPI/4.1.4"
    environment_variables: {}
    directory: "../7_mpi"
    build_commands:
      - "cargo build --release"
    run_command: "mpirun likwid-perfctr -C S0:1/ -g MEM ./target/release/hpccg-rs"

benches:
  "roofline-parallelism":
    run_configurations:
      - "cpp-reference"
      - "cpp-openmp"
      - "cpp-mpi"
      - "rust-reference"
      - "rust-rayon"
      - "rust-mpi"
    reruns:
      number: 5
      highest_discard: 1
      lowest_discard: 1
      unaggregatable_metrics:
        - "Mesh x size"
        - "Total FLOPs"
    matrix:
      args:
        - "100 100 100"
    analysis:
      roofline_plots:
        - title: "Parallelism Roofline Plot"
          gflops_per_sec: "Total MFLOPs/s"
          mbytes_per_sec: "Memory Bandwidth"
          ert_json: "./yaml_examples/old/roofline.json"
      metrics:
        "Mesh x size": "nx: (\\d+)"
        "Total time (s)": "Time Summary:[\\s\\S]*Total\\s*: ([\\d\\.]+)[\\s\\S]*\nFLOPS Summary"
        "Total FLOPs": "FLOPS Summary:[\\s\\S]*Total\\s*: ([\\d\\.]+)[\\s\\S]*\nMFLOPS Summary"
        "Total MFLOPs/s": "MFLOPS Summary:[\\s\\S]*Total\\s*: ([\\d\\.]+)"
        "Memory Bandwidth": "\\|\\s+Memory bandwidth\ \\[MBytes\/s\\]\\s+\\|\\s+([\\d\\.]+)\ \\|"
        "Wall time (s)": "real\\s([\\d\\.]+)\nuser"
